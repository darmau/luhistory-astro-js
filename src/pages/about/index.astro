---
import { sanityClient } from "sanity:client";
import { Image } from "astro:assets";
import PageTitle from "@/components/PageTitle.astro";
import Layout from "@/layouts/Layout.astro";
import TextBlock from "@/components/text-block/TextBlock.astro";
import PageBlock from "@/components/PageBlock.astro";
import downloadIcon from "@/assets/icons/download.svg";
import { createPortableTextProcessor } from "@/utils/portableText";

const { processPortableBlocks, processPageBlocks } =
  createPortableTextProcessor(sanityClient);

const rawProfileData = await sanityClient.fetch(`*[_type == 'profile' ]{
  "cvLink": cvLink.asset->url,
  "overview": overview[] {
    _type == 'imageBlock' => {
      type,
      "url": image.asset->url,
      "caption": image.caption
    },
    _type == 'gallery' => {
      type,
      title,
      "pictures": images[]{
        "url": asset->url,
        caption
      }
    },
    _type == "block" => {
      _type,
      style,
      listItem,
      level,
      "children": children[]{
        _type == "span" => { _key, text, marks },
        _type != "span" => { ... }
      },
      "markDefs": markDefs[]{
        _key,
        _type,
        href,
        reference,
        note,
        // 直接解引用 reference 获取 type 和 slug
        "refType": reference->_type,
        "refSlug": reference->slug.current
      }
    },
    ...
  },
  "blocks": pageBlock[]{
    _type == 'gallery' => {
      title, 
      "category": 'gallery',
      "gallery": type, 
      "images": images[]{
        caption,
        "url": asset->url
      }
    },
    _type == 'timeline' => {
      "category": 'timeline',
      ...
    },
    _type == 'content' => {
      "category": 'content',
      title,
      "content": content[] {
        _type == 'imageBlock' => {
          _type,
          type,
          "url": image.asset->url,
          "caption": image.caption
        },
        _type == 'gallery' => {
          _type,
          type,
          title,
          "pictures": images[]{
            "url": asset->url,
            caption
          }
        },
        _type == "block" => {
          _type,
          style,
          listItem,
          level,
          "children": children[]{
            _type == "span" => { _key, text, marks },
            _type != "span" => { ... }
          },
          "markDefs": markDefs[]{
            _key,
            _type,
            href,
            reference,
            note,
            // 直接解引用 reference 获取 type 和 slug
            "refType": reference->_type,
            "refSlug": reference->slug.current
          }
        },
        ...
      }
    },
  }
}`);

const processedProfileData = await Promise.all(
  rawProfileData.map(async (profile: any) => {
    const processedOverview = await processPortableBlocks(profile.overview);
    const processedBlocks = await processPageBlocks(profile.blocks);
    return {
      ...profile,
      overview: processedOverview,
      blocks: processedBlocks,
    };
  })
);

const profileData = processedProfileData[0] ?? {};
const { overview, blocks, cvLink } = profileData;
---

<Layout
  title="About Lu Peng"
  description="Learn more about Lu Peng's extensive academic research achievements, publications, exhibitions, and scholarly contributions in art history and curation."
  type="website"
>
  <PageTitle title="About" description="" />
  <main
    class="px-4 flex flex-col gap-4 py-8 md:grid md:grid-cols-12 md:gap-8 md:py-16 lg:max-w-8xl lg:mx-auto 8xl:px-0"
  >
    <div class="col-span-3 lg:col-span-4 flex items-start gap-4 my-3">
      <Image src={downloadIcon} alt="download" width="24" height="24" />
      <a
        href={cvLink}
        target="_blank"
        class="text-neutral-900 opacity-50 hover:opacity-100">Download CV</a
      >
    </div>
    <div class="col-start-4 col-end-12">
      <TextBlock overview={overview} />
      {blocks && <PageBlock blocks={blocks} />}
    </div>
  </main>
</Layout>

<style is:global>
  .swiper {
    overflow: visible !important;
  }
</style>
