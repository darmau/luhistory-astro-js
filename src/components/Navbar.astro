---
import { Image } from "astro:assets";
import favicon from "../assets/icons/favicon.svg";
import faviconWhite from "../assets/icons/favicon-white.svg";
import closeWhite from "../assets/icons/close-white.svg";
import menuIcon from "../assets/icons/menu.svg";
import searchIcon from "../assets/icons/search.svg";

---

<!--该部分为全屏导航-->
<div
  id="nav-fullscreen"
  class="hidden bg-neutral-900 w-screen h-screen fixed inset-0"
>
  <hgroup class="w-full flex justify-between items-center p-8">
    <a href="/" data-astro-reload>
      <Image src={faviconWhite} alt="logo" class="cursor-pointer" />
    </a>
    <Image
      id="close-button"
      src={closeWhite}
      alt="close button"
      class="cursor-pointer"
    />
  </hgroup>
  <div
    class="grid grid-cols-1 gap-4 lg:gap-16 px-8 md:grid-cols-2 md:p-8 lg:grid-cols-5 lg:gap-3 lg:p-16"
  >
    <ul class="pl-0 col-span-1 lg:col-span-3 lg:mx-auto space-y-4 md:space-y-8">
      <li class="w-fit list-none">
        <a
          class="text-white font-serif font-bold text-3xl md:text-5xl no-underline"
          href="/about"
          data-astro-prefetch="load">About</a
        >
      </li>
      <li class="w-fit list-none">
        <a
          class="text-white font-serif font-bold text-3xl md:text-5xl no-underline"
          href="/exhibition"
          data-astro-prefetch="load">Exhibitions</a
        >
      </li>
      <li class="w-fit list-none">
        <a
          class="text-white font-serif font-bold text-3xl md:text-5xl no-underline"
          href="/book/category"
          data-astro-prefetch="load">Publications</a
        >
      </li>
      <li class="w-fit list-none">
        <a
          class="text-white font-serif font-bold text-3xl md:text-5xl no-underline"
          href="/teaching"
          data-astro-prefetch="load">Teaching</a
        >
      </li>
      <li class="w-fit list-none">
        <a
          class="text-white font-serif font-bold text-3xl md:text-5xl no-underline"
          href="/collection/all/1/"
          data-astro-prefetch="load">Collection</a
        >
      </li>
      <li class="w-fit list-none">
        <a
          class="text-white font-serif font-bold text-3xl md:text-5xl no-underline"
          href="/on-artists"
          data-astro-prefetch="load">On Artists</a
        >
      </li>
    </ul>
    <div class="col-span-1 space-y-12 lg:col-span-2">
      <div class="space-y-4">
        <h3
          class="text-white font-normal font-sans text-sm uppercase opacity-50 tracking-widest"
        >
          Social
        </h3>
        <h4>
          <a
            href="https://weibo.com/u/1087499432"
            rel="noopener noreferrer"
            target="_blank"
            class="no-underline text-white font-serif font-bold text-2xl md:text-4xl"
          >
            Weibo
          </a>
        </h4>
        <h4>
          <a
            href="https://www.xiaohongshu.com/user/profile/614f52d2000000001f03f1e4"
            rel="noopener noreferrer"
            target="_blank"
            class="no-underline text-white font-serif font-bold text-2xl md:text-4xl"
          >
            Xiaohongshu
          </a>
        </h4>
        <h4>
          <a
            href="https://www.instagram.com/lvpeng60"
            rel="noopener noreferrer"
            target="_blank"
            class="no-underline text-white font-serif font-bold text-2xl md:text-4xl"
          >
            Instagram
          </a>
        </h4>
      </div>
      <div class="space-y-4">
        <h3
          class="text-white font-normal font-sans text-sm uppercase opacity-50 tracking-widest"
        >
          Contact
        </h3>
        <h4 class="font-serif font-bold text-2xl md:text-4xl">
          <a
            class="text-white no-underline"
            href="mailto:info@luhistory.com"
            target="_blank">info@luhistory.com</a
          >
        </h4>
      </div>
    </div>
  </div>
</div>
<!--导航-->
<nav
  class="fixed flex gap-8 justify-between items-center py-2 px-4 xl:px-0 max-w-8xl w-full mx-auto xl:grid xl:grid-cols-12 xl:py-8 z-10 top-0 left-1/2 -translate-x-1/2"
>
  <div
    class="col-start-1 h-4 w-14 md:w-28 md:h-8 flex justify-center items-center"
  >
    <a href="/" data-astro-reload>
      <Image src={favicon} alt="logo" class="cursor-pointer" />
    </a>
  </div>
  <div class="col-start-12 justify-self-end flex items-center gap-4">
    <div class="nav-search-container relative flex items-center justify-center h-10 w-10 md:w-auto z-20">
      <button
        id="nav-search-toggle"
        type="button"
        class="w-5 h-5 md:w-10 md:h-10 flex items-center justify-center cursor-pointer"
        aria-label="Search this site"
        aria-controls="nav-search-form"
        aria-expanded="false"
      >
        <Image src={searchIcon} alt="search" class="w-full h-full" />
      </button>
      <form
        id="nav-search-form"
        role="search"
        class="hidden absolute right-0 top-1/2 -translate-y-1/2 items-center gap-2 bg-transparent md:static md:translate-y-0 md:ml-3"
      >
        <input
          id="nav-search-input"
          type="search"
          name="q"
          placeholder="Search this site"
          class="bg-transparent outline-none border-0 border-b-2 border-neutral-900 text-sm md:text-base text-neutral-900 placeholder-neutral-500 w-32 md:w-48 px-2 py-1"
          autocomplete="off"
        />
        <button
          id="nav-search-submit"
          type="submit"
          class="text-sm uppercase md:text-base font-medium text-neutral-900 bg-transparent border-0 cursor-pointer px-2 py-1"
        >
          Search
        </button>
      </form>
    </div>
    <div class="w-5 h-5 md:w-10 md:h-10 menu-button">
      <Image src={menuIcon} alt="menu" class="w-full h-full cursor-pointer" />
    </div>
  </div>
</nav>

<script>
  declare global {
    interface Window {
      __luhistoryNavSearchOutsideHandler?: (event: MouseEvent) => void;
    }
  }

  function init() {
    const navFullscreen = document.getElementById("nav-fullscreen");
    const closeButton = document.getElementById("close-button");
    const menuButton = document.querySelector(".menu-button");
    const searchToggle = document.getElementById("nav-search-toggle");
    const searchForm = document.getElementById("nav-search-form");
    const searchInput = document.getElementById("nav-search-input") as HTMLInputElement | null;
    const searchContainer = document.querySelector(".nav-search-container");

    if (closeButton) {
      closeButton.addEventListener("click", () => {
        navFullscreen?.classList.remove("show-fullscreen-nav");
        // 恢复滚动
        document.body.style.overflow = "auto";
      });
    }

    if (menuButton) {
      menuButton.addEventListener("click", () => {
        navFullscreen?.classList.add("show-fullscreen-nav");
        console.log("clicked!");
        // 禁用滚动
        document.body.style.overflow = "hidden";
      });
    }

    if (
      searchToggle &&
      searchForm &&
      searchInput &&
      !searchToggle.dataset.bound
    ) {
      const showSearchForm = () => {
        searchForm.classList.remove("hidden");
        searchForm.classList.add("flex");
        searchToggle.classList.add("hidden");
        searchToggle.setAttribute("aria-expanded", "true");
        requestAnimationFrame(() => searchInput.focus());
      };

      const collapseSearchForm = () => {
        searchForm.classList.remove("flex");
        searchForm.classList.add("hidden");
        searchToggle.classList.remove("hidden");
        searchToggle.setAttribute("aria-expanded", "false");
      };

      const performSearch = () => {
        const query = searchInput.value.trim();
        if (!query) {
          searchInput.focus();
          return;
        }

        const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(`site:luhistory.com ${query}`)}`;
        window.open(searchUrl, "_blank", "noopener");
        searchInput.value = "";
        collapseSearchForm();
      };

      searchToggle.addEventListener("click", () => {
        const formHidden = searchForm.classList.contains("hidden");
        if (formHidden) {
          showSearchForm();
        } else {
          collapseSearchForm();
        }
      });

      searchForm.addEventListener("submit", (event) => {
        event.preventDefault();
        performSearch();
      });

      searchInput.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          collapseSearchForm();
        }
      });

      if (window.__luhistoryNavSearchOutsideHandler instanceof Function) {
        document.removeEventListener(
          "click",
          window.__luhistoryNavSearchOutsideHandler,
        );
      }

      const outsideClickHandler = (event: MouseEvent) => {
        const isHidden = searchForm.classList.contains("hidden");
        if (isHidden) {
          return;
        }

        const target = event.target;
        if (
          searchContainer &&
          target instanceof Node &&
          !searchContainer.contains(target)
        ) {
          collapseSearchForm();
        }
      };

      document.addEventListener("click", outsideClickHandler);
      window.__luhistoryNavSearchOutsideHandler = outsideClickHandler;

      searchToggle.dataset.bound = "true";
    }
  }

  // 初始化
  init();

  // 监听 astro:after-swap 事件
  document.addEventListener("astro:after-swap", init);
</script>

<style>
  .show-fullscreen-nav {
    display: block;
    transition: all 1s ease-in-out;
    z-index: 100;
  }
</style>
