---
import SingleImage from "./SingleImage.astro";
import Gallery from "../page-block/Gallery.astro";
import FootnoteContent from "./FootnoteContent.astro";
import SubscriptMark from "./SubscriptMark.astro";
import { PortableText } from "astro-portabletext";
import type { PortableTextBlock } from "@portabletext/types";
import type { TextBlockProps } from "@/types";

const { overview = [], title } = Astro.props as TextBlockProps;

// 收集所有注释
const footnotes: Array<{ note: string; id: string; index: number }> = [];
let footnoteIndex = 1;

// 处理PortableText中的注释
const processPortableText = (blocks: PortableTextBlock[]) => {
  return blocks.map((block) => {
    if (block._type === 'block' && block.markDefs) {
      // 处理markDefs中的注释
      block.markDefs.forEach((markDef: any) => {
        if (markDef._type === 'subscript' && markDef.note) {
          const id = markDef._key;
          footnotes.push({
            note: markDef.note,
            id: id,
            index: footnoteIndex++
          });
        }
      });
    }
    return block;
  });
};

// 处理所有块中的注释
const processedOverview = overview && overview.length > 0 ? overview.map((block: any) => {
  if (block._type === 'block' && block.body) {
    return {
      ...block,
      body: processPortableText(block.body)
    };
  }
  return block;
}) : [];

// 如果没有body，直接处理overview中的注释
if (overview && overview.length > 0) {
  overview.forEach((block: any) => {
    if (block._type === 'block' && block.markDefs) {
      block.markDefs.forEach((markDef: any) => {
        if (markDef._type === 'subscript' && markDef.note) {
          const id = markDef._key;
          footnotes.push({
            note: markDef.note,
            id: id,
            index: footnoteIndex++
          });
        }
      });
    }
  });
}

// 建立全局注释映射与索引（供自定义 mark 组件读取）
if (typeof globalThis !== 'undefined') {
  const map: Record<string, { index: number; note: string }> = {};
  for (const f of footnotes) {
    map[f.id] = { index: f.index, note: f.note };
  }
  (globalThis as any).__footnoteMap = map;
}
---

<div class = "text-block-container mt-8 md:col-span-8 md:grid md:grid-cols-8 md:gap-4">
  {title && (
    <h2 class = "col-span-8 font-serif font-bold text-4xl md:text-6xl text-neutral-900 mb-8 md:mb-16">{title}</h2>
  )}
  { processedOverview && processedOverview.length > 0 && processedOverview.map((block) => {
    if (block._type === 'gallery') {
      return <Gallery gallery={block.type} title={block.title} images={block.pictures} />
    } else if (block._type === 'imageBlock') {
      return <SingleImage url={block.url} size={block.type} caption={block.caption} />
    } else if (block._type === 'videoEmbed') {
      return (
        <div class="col-span-8 video-embed-container">
          <div class="video-embed" set:html={block.embedCode} />
        </div>
      )
    } else {
      const portableBlock = block as PortableTextBlock | PortableTextBlock[];
      return (
        <div class="col-span-8">
          <PortableText 
            value={portableBlock}
            components={{
              mark: {
                // use custom renderer for subscript marks
                subscript: SubscriptMark as any,
              }
            }}
          />
        </div>
      )
    }
  })}
  
  <!-- 注释内容区域 -->
  {footnotes.length > 0 && (
    <div class="col-span-8 footnotes-section">
      <hr class="footnotes-divider" />
      <h3 class="footnotes-title">注释</h3>
      <div class="footnotes-list">
        {footnotes.map((footnote) => (
          <FootnoteContent 
            note={footnote.note} 
            index={footnote.index} 
            id={footnote.id} 
          />
        ))}
      </div>
    </div>
  )}
</div>

<style is:global>
  .text-block-container h2 {
    font-family: 'Cormorant', serif;
    font-weight: 700;
    font-size: 40px;
    line-height: 56px;
    color: #171717;;
    margin-top: 32px;
    margin-bottom: 16px;
  }

  .text-block-container h3 {
    font-family: 'Cormorant', serif;
    font-weight: 700;
    font-size: 32px;
    line-height: 40px;
    color: #171717;;
    margin-top: 24px;
    margin-bottom: 16px;
  }

  .text-block-container h4 {
    font-family: 'Cormorant', serif;
    font-weight: 700;
    font-size: 24px;
    line-height: 32px;
    color: #171717;;
    margin-top: 24px;
    margin-bottom: 16px;
  }

  .text-block-container p {
    font-family: 'Cormorant', serif;
    font-weight: 400;
    font-size: 20px;
    line-height: 32px;
    color: #171717;
    margin-top: 8px;
    margin-bottom: 8px;
  }

  .text-block-container blockquote {
    font-family: 'Cormorant', serif;
    font-weight: 400;
    font-size: 16px;
    line-height: 28px;
    color: #171717;
    margin-top: 0;
    margin-bottom: 16px;
    border-left: 2px solid #171717;
    padding-left: 16px;
  }

  .text-block-container code {
    font-family: monospace;
    font-weight: 400;
    font-size: 16px;
    background-color: #F5F5F5;
    padding: 2px 4px;
  }

  .text-block-container a {
    color: #171717;
    text-decoration: underline;
    text-decoration-thickness: 2px;
    text-underline-offset: 6px;
    text-decoration-color: #a3a3a3;
  }

  .text-block-container a:hover {
    text-decoration-color: #171717;
    text-decoration-thickness: 3px;
    transition: all 0.3s ease-in-out;
  }

  .text-block-container ul {
    margin-top: 0;
    margin-bottom: 16px;
    padding-left: 24px;
    list-style-type: disc;
    font-family: 'Cormorant', serif;
    font-weight: 400;
    font-size: 20px;
    line-height: 36px;
    color: #171717;
  }

  .text-block-container ol {
    margin-top: 16px;
    margin-bottom: 16px;
    padding-left: 24px;
    list-style-type: decimal;
    font-family: 'Cormorant', serif;
    font-weight: 400;
    font-size: 20px;
    line-height: 36px;
    color: #171717;
  }

  /* 注释区域样式 */
  .footnotes-section {
    margin-top: 48px;
    padding-top: 24px;
  }

  .footnotes-divider {
    border: none;
    border-top: 1px solid #666666;
    margin-bottom: 24px;
  }

  .footnotes-title {
    font-family: 'Cormorant', serif;
    font-weight: 700;
    font-size: 20px;
    line-height: 28px;
    color: #171717;
    margin-bottom: 8px;
  }

  .footnotes-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  /* 视频嵌入样式 */
  .video-embed-container {
    margin: 24px 0;
  }

  .video-embed {
    position: relative;
    width: 100%;
    height: 0;
    padding-bottom: 56.25%; /* 16:9 宽高比 */
    overflow: hidden;
  }

  .video-embed iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
  }
</style>
