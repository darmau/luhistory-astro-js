---
import { sanityClient } from "sanity:client";
import CaseSlider from "./slider/CaseSlider.tsx";
import type { CaseItem } from "@/types";
import { buildRemoteImageSetOrNull } from "@/utils/remoteImage";

const casesRaw = await sanityClient.fetch<CaseItem[]>(`
*[_type == "caseStudy" && defined(slug) && defined(cover)] | order(publishDate desc)[0...5] {
    title,
    "slug": slug.current,
    "cover": cover.image.asset->url
    }`);

const caseWidths = [320, 480, 720, 960];
const caseSizes = "(max-width: 1023px) 100vw, calc(50vw - 3rem)";

const casesData = await Promise.all(
  casesRaw.map(async (item) => {
    if (!item.cover) {
      return { ...item, coverImage: null } satisfies CaseItem;
    }

    const coverImage = await buildRemoteImageSetOrNull({
      src: item.cover,
      alt: item.title,
      widths: caseWidths,
      sizes: caseSizes,
    });

    if (!coverImage) {
      console.warn("Falling back to remote Sanity image", { slug: item.slug });
    }

    return { ...item, coverImage } satisfies CaseItem;
  }),
);
---

<div
  class="col-start-1 col-span-12 mb-8 p-4 sm:p-0 sm:col-start-2 sm:col-span-10 lg:mb-40"
>
  <hgroup
    class="flex justify-between items-baseline text-neutral-900 mb-8 md:mb-20"
  >
    <h2 class="font-title font-bold text-3xl md:text-5xl">On Artists</h2>
    <div class="flex items-center gap-2">
      <a
        href="/on-artists"
        class="font-title text-lg md:text-2xl font-thin"
        data-astro-prefetch="viewport">View more&nbsp;&nbsp;â†’</a
      >
    </div>
  </hgroup>
  <div class="w-full">
    <div class="overflow-visible">
      {casesData && <CaseSlider client:visible cases={casesData} />}
    </div>
  </div>
</div>

<style>
  .cover-img {
    width: 320px;
    height: 213px;
  }

  @media (min-width: 768px) {
    .cover-img {
      width: 528px;
      height: 352px;
    }
  }
</style>
